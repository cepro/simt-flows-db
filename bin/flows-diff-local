#!/bin/sh
set -e

BIN_DIR=`dirname $0`
PROJECT_ROOT=`dirname $BIN_DIR`

# start a shadow db to load up migrations as a comparison point
echo "Starting shadow timescale database\n"
SQITCH_TARGET=local-diff-shadow
SHADOW_CONTAINER=flows-timescaledb-$SQITCH_TARGET
docker run -d --name $SHADOW_CONTAINER \
            -p 25432:5432 \
            -e POSTGRES_PASSWORD=postgres \
            timescale/timescaledb-ha:pg17 > /dev/null

# give postgres some time to start
sleep 5

# run migrations on shadow
echo "Apply migrations to shadow timescale database\n"
cd $PROJECT_ROOT/sqitch
sqitch deploy $SQITCH_TARGET
cd - > /dev/null

echo "\nShadow db setup finished.\n"

# diff local with the shadow  
echo "\n================        diff        =================\n"
MIGRA_IMAGE=public.ecr.aws/supabase/migra:3.0.1663481299
set +e
docker run --rm -it --network host $MIGRA_IMAGE migra --unsafe \
    "postgresql://postgres:postgres@localhost:25432/postgres" \
    "postgresql://postgres:postgres@localhost:15432/postgres"
if [ "$?" = "0" ]; then
    echo "No changes\n"
fi

docker rm -f $SHADOW_CONTAINER > /dev/null
